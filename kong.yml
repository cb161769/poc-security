_format_version: "3.0"
_transform: true

#############################
# SERVICES
#############################

services:

  # ============================
  # API NODE (LOCALHOST HOST)
  # ============================
  - name: node-api-service
    url: http://host.docker.internal:3000
    routes:
      - name: mobile-api-route
        paths:
          - /api/v1/mobile
        strip_path: true
        methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]

      - name: web-api-route
        paths:
          - /api/v1/web
        strip_path: true
        methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]

#############################
# PLUGINS (GLOBAL)
#############################

plugins:

  # ============================
  # 1️⃣ CORS – DEV LOCAL
  # ============================
  - name: cors
    config:
      origins:
        - http://localhost:8100
        - http://localhost:4200
      methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
      headers:
        - Authorization
        - Content-Type
        - X-App-Fingerprint
      exposed_headers:
        - X-Request-Id
      credentials: false
      max_age: 3600

  # ============================
  # 2️⃣ OPENID CONNECT (JWT OFFLINE)
  # ============================
  - name: openid-connect
    config:
      issuer: "http://localhost:8080/realms/mobile-realm"
      auth_methods: ["bearer"]
      discovery: true

      bearer_token_param_type:
        - header

      verify_claims:
        iss: "http://localhost:8080/realms/mobile-realm"
        aud: "mobile-api"

      upstream_headers_claims: []
      header_names: []

      access_token_jwt_leeway: 30

  # ============================
  # 3️⃣ RATE LIMITING POR TOKEN
  # ============================
  - name: rate-limiting
    config:
      minute: 120
      policy: local
      limit_by: header
      header_name: Authorization
      hide_client_headers: true

  # ============================
  # 4️⃣ REQUEST ID
  # ============================
  - name: correlation-id
    config:
      header_name: X-Request-Id
      generator: uuid
      echo_downstream: true

  # ============================
  # 5️⃣ HEADERS DE SEGURIDAD
  # ============================
  - name: response-transformer
    config:
      add:
        headers:
          - X-Content-Type-Options:nosniff
          - X-Frame-Options:DENY
          - Referrer-Policy:no-referrer
          - Permissions-Policy:geolocation=()

#############################
# FIN
#############################